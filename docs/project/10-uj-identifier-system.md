# 10. Система идентификаторов УЖ (UJ Identifier System)

## 10.1 Обзор системы

**Назначение**: Трехуровневая система уникальных идентификаторов для объектов недвижимости.

**Формат**: `UJ000000-ZD00-EL000`

**Компоненты**:
- **Уровень I**: Проект (UJ000000)
- **Уровень II**: Здание (ZD00 где Z - тип, D - префикс)
- **Уровень III**: Помещение (EL000 где E - префикс, L - тип)

**Источник**: `src/lib/uj-identifier.js`

## 10.2 Уровень I: Идентификатор проекта (UJ)

### Формат

```
UJ000000
│ └─────── 6-значный порядковый номер (000001, 000002, ...)
└────────── Префикс "УЖ" (Управление Жилищным фондом)
```

### Генерация

**Функция**: `generateProjectCode(sequenceNumber)`

**Алгоритм**:
1. При создании проекта система запрашивает все существующие `uj_code` в текущем `scope_id`
2. Находит максимальный номер среди существующих кодов
3. Инкрементирует на 1
4. Форматирует с дополнением нулями до 6 знаков

**Код**:
```javascript
export const generateProjectCode = sequenceNumber => {
  const num = parseInt(sequenceNumber, 10) || 0;
  return `UJ${String(num).padStart(6, '0')}`;
};
```

### Примеры

| Порядковый номер | Результат |
|-----------------|-----------|
| 1 | UJ000001 |
| 42 | UJ000042 |
| 1000 | UJ001000 |
| 999999 | UJ999999 |

### Хранение в БД

- **Таблица**: `projects`
- **Поле**: `uj_code` (TEXT, UNIQUE)
- **Генерация**: При создании проекта (шаг `composition`)
- **Функция**: `generateNextProjectCode(scope)`

### Валидация

**Регулярное выражение**: `/^UJ\d{6}$/`

**Функция**: `isValidProjectCode(code)`

**Проверки**:
- Начинается с "UJ"
- Содержит ровно 6 цифр
- Общая длина: 8 символов

## 10.3 Уровень II: Идентификатор здания (ZD)

### Формат

```
ZD00
│└──── 2-значный порядковый номер (01, 02, ..., 99)
└───── Префикс типа здания (ZR, ZM, ZP, ZI)
```

### Префиксы типов зданий

| Префикс | Тип здания | Категория в БД | Условие |
|---------|-----------|----------------|---------|
| **ZR** | Жилой дом (одноблочный) | `residential` | `blocks.length === 1` |
| **ZM** | Многоблочный жилой дом | `residential` или `residential_multiblock` | `blocks.length > 1` |
| **ZP** | Паркинг | `parking_separate` | - |
| **ZI** | Инфраструктура | `infrastructure` | - |

### Определение префикса

**Функция**: `getBuildingPrefix(category, hasMultipleBlocks)`

**Логика**:
```javascript
export const getBuildingPrefix = (category, hasMultipleBlocks = false) => {
  if (category === 'residential' || category === 'residential_main') {
    return hasMultipleBlocks ? 'ZM' : 'ZR';
  }
  return BUILDING_TYPE_PREFIXES[category] || 'ZR';
};
```

**Примеры**:
- Жилой дом с 1 блоком → `ZR`
- Жилой дом с 3 блоками → `ZM`
- Отдельный паркинг → `ZP`
- Школа → `ZI`

### Генерация

**Функция**: `generateBuildingCode(prefix, sequenceNumber)`

**Алгоритм**:
1. Определяется префикс на основе категории и количества блоков
2. Система запрашивает все существующие здания проекта
3. Фильтрует здания с тем же префиксом
4. Находит максимальный номер
5. Инкрементирует на 1
6. Форматирует с дополнением нулями до 2 знаков

**Код**:
```javascript
export const generateBuildingCode = (prefix, sequenceNumber) => {
  const num = parseInt(sequenceNumber, 10) || 0;
  return `${prefix}${String(num).padStart(2, '0')}`;
};
```

### Примеры

| Префикс | Порядковый номер | Результат |
|---------|-----------------|-----------|
| ZR | 1 | ZR01 |
| ZM | 2 | ZM02 |
| ZP | 1 | ZP01 |
| ZI | 3 | ZI03 |

### Полный идентификатор здания

**Формат**: `UJ000000-ZD00`

**Примеры**:
- `UJ000001-ZR01` — Первый одноблочный жилой дом в проекте UJ000001
- `UJ000001-ZM01` — Первый многоблочный жилой дом в проекте UJ000001
- `UJ000001-ZP01` — Первый паркинг в проекте UJ000001
- `UJ000002-ZI01` — Первая инфраструктура в проекте UJ000002

### Хранение в БД

- **Таблица**: `buildings`
- **Поле**: `building_code` (TEXT, UNIQUE)
- **Генерация**: При создании здания (шаг `composition`)
- **Функция**: `generateNextBuildingCode(projectId, category, blocksCount)`

### Валидация

**Регулярное выражение**: `/^Z[RMPI]\d{2}$/`

**Функция**: `isValidBuildingCode(code)`

**Проверки**:
- Начинается с "Z"
- Второй символ: R, M, P или I
- Содержит ровно 2 цифры
- Общая длина: 4 символа

## 10.4 Уровень III: Идентификатор помещения (EL)

### Формат

```
EL000
│└──── 3-значный порядковый номер (001, 002, ..., 999)
└───── Префикс типа помещения (EF, EO, EP)
```

### Префиксы типов помещений

| Префикс | Тип помещения | Типы в БД (`unit_type`) |
|---------|--------------|------------------------|
| **EF** | Квартира | `flat`, `duplex_up`, `duplex_down` |
| **EO** | Офис/Нежилое | `office`, `office_inventory`, `non_res_block`, `infrastructure` |
| **EP** | Машиноместо | `parking_place` |

### Определение префикса

**Функция**: `getUnitPrefix(unitType)`

**Маппинг**:
```javascript
export const UNIT_TYPE_PREFIXES = {
  flat: 'EF',
  duplex_up: 'EF',
  duplex_down: 'EF',
  office: 'EO',
  office_inventory: 'EO',
  non_res_block: 'EO',
  infrastructure: 'EO',
  parking_place: 'EP',
};
```

### Генерация

**Функция**: `generateUnitCode(prefix, sequenceNumber)`

**Алгоритм**:
1. Определяется префикс на основе типа помещения
2. Система запрашивает все существующие помещения здания
3. Фильтрует помещения с тем же префиксом
4. Находит максимальный номер
5. Инкрементирует на 1
6. Форматирует с дополнением нулями до 3 знаков

**Код**:
```javascript
export const generateUnitCode = (prefix, sequenceNumber) => {
  const num = parseInt(sequenceNumber, 10) || 0;
  return `${prefix}${String(num).padStart(3, '0')}`;
};
```

### Примеры

| Префикс | Порядковый номер | Результат |
|---------|-----------------|-----------|
| EF | 1 | EF001 |
| EF | 42 | EF042 |
| EO | 1 | EO001 |
| EP | 100 | EP100 |

### Полный идентификатор помещения

**Формат**: `UJ000000-ZD00-EL000`

**Примеры**:
- `UJ000001-ZR01-EF001` — Первая квартира в первом жилом доме проекта UJ000001
- `UJ000001-ZR01-EF042` — 42-я квартира в первом жилом доме
- `UJ000001-ZM02-EF001` — Первая квартира во втором многоблочном доме
- `UJ000001-ZR01-EO001` — Первое нежилое помещение в первом жилом доме
- `UJ000001-ZP01-EP001` — Первое машиноместо в первом паркинге

### Хранение в БД

- **Таблица**: `units`
- **Поле**: `unit_code` (TEXT, UNIQUE)
- **Генерация**: При создании помещения (шаг `apartments`)
- **Функция**: `generateNextUnitCode(buildingId, unitType)`

### Валидация

**Регулярное выражение**: `/^E[FOP]\d{3}$/`

**Функция**: `isValidUnitCode(code)`

**Проверки**:
- Начинается с "E"
- Второй символ: F, O или P
- Содержит ровно 3 цифры
- Общая длина: 5 символов

## 10.5 Формирование полного идентификатора

### Функция

**Название**: `formatFullIdentifier(projectCode, buildingCode, unitCode)`

**Логика**:
```javascript
export const formatFullIdentifier = (projectCode, buildingCode = null, unitCode = null) => {
  if (!projectCode) return '';
  if (!buildingCode) return projectCode;
  
  const parts = [projectCode, buildingCode];
  if (unitCode) {
    parts.push(unitCode);
  }
  
  return parts.filter(Boolean).join('-');
};
```

### Примеры формирования

| Компоненты | Результат |
|-----------|-----------|
| `UJ000001` | `UJ000001` |
| `UJ000001`, `ZR01` | `UJ000001-ZR01` |
| `UJ000001`, `ZR01`, `EF042` | `UJ000001-ZR01-EF042` |

## 10.6 Парсинг идентификатора

### Функция

**Название**: `parseIdentifier(identifier)`

**Логика**:
```javascript
export const parseIdentifier = identifier => {
  if (!identifier) {
    return { projectCode: null, buildingCode: null, unitCode: null };
  }
  
  const parts = String(identifier).split('-');
  
  return {
    projectCode: parts[0] || null,
    buildingCode: parts[1] || null,
    unitCode: parts[2] || null,
  };
};
```

### Примеры парсинга

| Идентификатор | projectCode | buildingCode | unitCode |
|--------------|-------------|--------------|----------|
| `UJ000001` | `UJ000001` | `null` | `null` |
| `UJ000001-ZR01` | `UJ000001` | `ZR01` | `null` |
| `UJ000001-ZR01-EF042` | `UJ000001` | `ZR01` | `EF042` |

## 10.7 Извлечение порядкового номера

### Функция

**Название**: `extractNumber(code)`

**Логика**:
```javascript
export const extractNumber = code => {
  if (!code) return 0;
  const match = String(code).match(/\d+$/);
  return match ? parseInt(match[0], 10) : 0;
};
```

### Примеры

| Код | Результат |
|-----|-----------|
| `UJ000001` | 1 |
| `ZR01` | 1 |
| `ZM42` | 42 |
| `EF123` | 123 |

## 10.8 Получение следующего номера

### Функция

**Название**: `getNextSequenceNumber(existingCodes, prefix)`

**Логика**:
```javascript
export const getNextSequenceNumber = (existingCodes, prefix = null) => {
  if (!existingCodes || existingCodes.length === 0) {
    return 1;
  }
  
  const filtered = prefix
    ? existingCodes.filter(code => String(code).startsWith(prefix))
    : existingCodes;
  
  if (filtered.length === 0) {
    return 1;
  }
  
  const numbers = filtered.map(extractNumber).filter(n => n > 0);
  
  if (numbers.length === 0) {
    return 1;
  }
  
  return Math.max(...numbers) + 1;
};
```

### Примеры

**Существующие коды**: `['UJ000001', 'UJ000002', 'UJ000005']`

- `getNextSequenceNumber(codes, 'UJ')` → `6`

**Существующие коды**: `['ZR01', 'ZR02', 'ZM01']`

- `getNextSequenceNumber(codes, 'ZR')` → `3`
- `getNextSequenceNumber(codes, 'ZM')` → `2`

## 10.9 Использование в системе

### При создании проекта

**Шаг**: `composition`

**Действие**:
1. Пользователь заполняет паспорт проекта
2. Система автоматически генерирует `uj_code`
3. Запрос к БД: `SELECT uj_code FROM projects WHERE scope_id = ? ORDER BY uj_code DESC`
4. Вычисление следующего номера
5. Сохранение в `projects.uj_code`

### При создании здания

**Шаг**: `composition`

**Действие**:
1. Пользователь добавляет здание
2. Определяется категория и количество блоков
3. Выбирается префикс (ZR/ZM/ZP/ZI)
4. Запрос к БД: `SELECT building_code FROM buildings WHERE project_id = ? AND building_code LIKE 'ZR%'`
5. Вычисление следующего номера для данного префикса
6. Сохранение в `buildings.building_code`

### При создании помещения

**Шаг**: `apartments`

**Действие**:
1. Пользователь добавляет помещение
2. Определяется тип помещения
3. Выбирается префикс (EF/EO/EP)
4. Запрос к БД: `SELECT unit_code FROM units WHERE building_id = ? AND unit_code LIKE 'EF%'`
5. Вычисление следующего номера для данного префикса
6. Сохранение в `units.unit_code`

## 10.10 Отображение в UI

### Компонент идентификатора

**Компонент**: `IdentifierBadge.jsx`

**Использование**:
```jsx
<IdentifierBadge 
  projectCode="UJ000001"
  buildingCode="ZR01"
  unitCode="EF042"
/>
```

**Отображение**: 
```
┌─────────────────────────────────┐
│ UJ000001 - ZR01 - EF042        │
│ ▲         ▲       ▲             │
│ │         │       └─ Помещение  │
│ │         └───────── Здание     │
│ └─────────────────── Проект     │
└─────────────────────────────────┘
```

### В реестрах

**Таблицы реестров**:
- Реестр квартир: показывает полный идентификатор `UJ000001-ZR01-EF042`
- Реестр нежилых помещений: показывает `UJ000001-ZR01-EO001`
- Реестр машиномест: показывает `UJ000001-ZP01-EP001`

### В интеграции с УЗКАД

**Использование**: Идентификаторы передаются в систему УЗКАД для получения кадастровых номеров.

**Маппинг**:
- `UJ000001-ZR01` → Запрос кадастрового номера здания
- `UJ000001-ZR01-EF042` → Запрос кадастрового номера помещения

## 10.11 Ограничения и особенности

### Ограничения

1. **Максимальное количество проектов в scope**: 999,999
2. **Максимальное количество зданий одного типа в проекте**: 99
3. **Максимальное количество помещений одного типа в здании**: 999

### Особенности

1. **Независимая нумерация**: Каждый тип здания (ZR, ZM, ZP, ZI) нумеруется независимо
2. **Независимая нумерация помещений**: Каждый тип помещения (EF, EO, EP) нумеруется независимо внутри здания
3. **Глобальная уникальность**: `uj_code`, `building_code`, `unit_code` уникальны глобально
4. **Неизменность**: После создания идентификаторы не изменяются

### Миграция и обратная совместимость

**Примечание**: При миграции существующих проектов необходимо:
1. Сгенерировать UJ-коды для проектов без кодов
2. Сгенерировать коды зданий на основе текущего состава
3. Сгенерировать коды помещений на основе типов

**Функция миграции**: Должна учитывать существующие ID и создавать коды на их основе.

## 10.12 Связь с кадастровыми номерами

### Проект

- **UJ-код**: `UJ000001`
- **Кадастровый номер ЖК**: `90:31:020120:1234` (из `projects.cadastre_number`)

### Здание

- **Код здания**: `UJ000001-ZR01`
- **Кадастровый номер здания**: `90:31:020120:1234:5` (из `buildings.cadastre_number`)
- **Получение**: Шаг `integration_buildings` запрашивает из УЗКАД

### Помещение

- **Код помещения**: `UJ000001-ZR01-EF042`
- **Кадастровый номер помещения**: `90:31:020120:1234:5:42` (из `units.cadastre_number`)
- **Получение**: Шаг `integration_units` запрашивает из УЗКАД

**Связь**: UJ-идентификатор используется как внутренний код, кадастровый номер — как официальный государственный идентификатор.
