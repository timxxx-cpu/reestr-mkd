# 7. Валидации и проверки (полное описание)

## 7.1 Обзор системы валидации

**Источник**: `src/lib/step-validators.js` и `src/lib/validators.js`

**Принцип работы**:
1. При попытке завершить шаг (`COMPLETE_STEP`) вызывается `validateStepCompletion(stepId, contextData)`
2. Для каждого шага определен валидатор в `STEP_VALIDATORS`
3. Валидатор возвращает массив ошибок или `null`
4. Если есть ошибки, переход на следующий шаг блокируется
5. Ошибки отображаются пользователю с указанием места и причины

**Структура ошибки**:
```javascript
{
  title: "Объект: Корпус 1 (Блок: Секция А)",
  description: "Поле \"Фундамент\" обязательно для заполнения."
}
```

## 7.2 Базовые валидаторы (Validators)

**Источник**: `src/lib/validators.js`

### 7.2.1 Проверка положительного числа

**Функция**: `Validators.checkPositive(value)`

**Назначение**: Проверка, что значение больше 0

**Использование**:
- Проверка площадей
- Проверка количественных показателей

**Примеры**:
```javascript
Validators.checkPositive(0)      // → "Значение должно быть больше 0"
Validators.checkPositive(-5)     // → "Значение должно быть больше 0"
Validators.checkPositive(10.5)   // → null (OK)
```

### 7.2.2 Проверка расхождения площадей (Правило 15%)

**Функция**: `Validators.checkDiff(areaProj, areaFact)`

**Назначение**: Проверка критического расхождения между проектной и фактической площадью

**Правило**: Расхождение не должно превышать 15%

**Формула**:
```javascript
const diff = Math.abs(areaProj - areaFact);
const percent = (diff / areaProj) * 100;
if (percent > 15) return error;
```

**Использование**: Проверка площадей этажей

**Примеры**:
- Проект: 100 м², Факт: 110 м² → 10% → OK
- Проект: 100 м², Факт: 120 м² → 20% → **Ошибка: "Критическое расхождение"**

### 7.2.3 Проверка высоты этажа

**Функция**: `Validators.floorHeight(floorType, height)`

**Назначение**: Проверка допустимого диапазона высоты этажа

**Правила**:
- Стандартный этаж: 2.0 - 6.0 м
- Технический этаж: 1.5 - 6.0 м
- Подвал: 1.8 - 4.0 м

**Использование**: Проверка `floors.height`

**Примеры**:
```javascript
Validators.floorHeight('standard', 2.7)   // → null (OK)
Validators.floorHeight('standard', 1.5)   // → "Высота должна быть 2.0-6.0 м"
Validators.floorHeight('technical', 1.8)  // → null (OK)
Validators.floorHeight('basement', 5.0)   // → "Высота должна быть 1.8-4.0 м"
```

### 7.2.4 Проверка обязательности лифта

**Функция**: `Validators.elevatorRequirement(isParking, isInfra, floorsCount, elevatorsCount)`

**Назначение**: Проверка наличия лифта для зданий выше 5 этажей

**Правило**: Здание выше 5 этажей обязано иметь хотя бы 1 лифт

**Исключения**:
- Паркинги
- Инфраструктура

**Использование**: Проверка `building_blocks.elevators_count` при `floors_to > 5`

**Примеры**:
```javascript
Validators.elevatorRequirement(false, false, 6, 0)   // → true (Ошибка)
Validators.elevatorRequirement(false, false, 6, 1)   // → false (OK)
Validators.elevatorRequirement(false, false, 4, 0)   // → false (OK, до 5 этажей)
Validators.elevatorRequirement(true, false, 6, 0)    // → false (OK, паркинг)
```

### 7.2.5 Проверка наличия коммерции

**Функция**: `Validators.commercialPresence(building, buildingDetails, blocks, mode)`

**Назначение**: Проверка соответствия флага `has_non_res_part` и фактических коммерческих этажей

**Правило**: Если в паспорте здания указано наличие коммерции (`has_non_res_part=true`), то в конфигурации должны быть отмечены коммерческие этажи

**Использование**: Проверка на шаге `registry_res`

**Логика**:
```javascript
if (building.hasNonResPart) {
  // Проверяем, есть ли хотя бы один коммерческий этаж в commercialFloors
  const hasCommercialFloors = blocks.some(block => {
    const details = buildingDetails[`${building.id}_${block.id}`];
    return details.commercialFloors && details.commercialFloors.length > 0;
  });
  
  return hasCommercialFloors;
}
```

## 7.3 Шаговые валидаторы (STEP_VALIDATORS)

### 7.3.1 Шаг `composition` — Состав объектов

**Функция**: `STEP_VALIDATORS.composition(data)`

**Проверяемые поля**:
- `composition` (массив зданий)

**Правила**:
1. В проекте должен быть хотя бы один жилой дом

**Таблицы БД**:
- `buildings.category` должен содержать `residential` или `residential_multiblock`

**Ошибка**:
```javascript
{
  title: 'Критическая ошибка состава',
  description: "В проекте отсутствует жилой дом. Необходимо добавить хотя бы один объект типа 'Жилой дом' или 'Многоблочный'."
}
```

**Примеры**:
- Проект только с паркингом → **Ошибка**
- Проект с жилым домом + паркинг → OK
- Проект с инфраструктурой → **Ошибка**

### 7.3.2 Шаг `registry_res` — Жилые блоки

**Функция**: `STEP_VALIDATORS.registry_res(data)` → `getBuildingErrors(building, buildingDetails, 'res')`

**Проверяемые поля**:
- `building_blocks.*`
- `block_construction.*`
- `block_engineering.*`
- `buildingDetails.*`

**Правила для жилых блоков**:

1. **Обязательные поля конструктива**:
   - `foundation` (Фундамент) — из `dict_foundations`
   - `walls` (Материал стен) — из `dict_wall_materials`
   - `slabs` (Перекрытия) — из `dict_slab_types`
   - `roof` (Кровля) — из `dict_roof_types`
   - `seismicity` (Сейсмичность) — число 0-9

2. **Обязательные поля геометрии**:
   - `entrances` (Количество подъездов) — число > 0
   - `floorsFrom` (Этажность от) — число > 0
   - `floorsTo` (Этажность до) — число >= floorsFrom

3. **Проверка лифтов**:
   - Если `floorsTo > 5` → требуется хотя бы 1 лифт
   - `elevators_count >= 1`

4. **Проверка коммерции**:
   - Если `has_non_res_part=true` → должны быть отмечены коммерческие этажи в `commercialFloors`

5. **Проверка собственного адреса**:
   - Если `hasCustomAddress=true` → `customHouseNumber` не должен быть пустым

**Таблицы БД**:
- `building_blocks` (floors_from, floors_to, entrances_count, elevators_count, has_custom_address, custom_house_number)
- `block_construction` (foundation, walls, slabs, roof, seismicity)
- `block_engineering` (все флаги инженерии)

**Примеры ошибок**:
```javascript
{
  title: "Объект: Корпус 1 (Блок: Основной блок)",
  description: "Поле \"Фундамент\" обязательно для заполнения."
}

{
  title: "Объект: Корпус 1 (Блок: Секция А)",
  description: "Здание выше 5 этажей (7 эт.) обязано иметь лифт."
}

{
  title: "Объект: Корпус 1",
  description: "В паспорте указано наличие коммерции, но ни в одном жилом блоке не отмечены коммерческие этажи."
}
```

### 7.3.3 Шаг `registry_nonres` — Нежилые блоки и инфраструктура

**Функция**: `STEP_VALIDATORS.registry_nonres(data)` → `getBuildingErrors(building, buildingDetails, 'nonres')`

**Проверяемые типы зданий**:
- Паркинги (`parking_separate`)
- Инфраструктура (`infrastructure`)

**Правила для капитального паркинга**:

1. **Обязательные поля конструктива**:
   - `foundation`, `walls`, `slabs`, `roof`, `seismicity`
   - `vehicleEntries` (Въезды)
   - `inputs` (Входы)

2. **Для подземного паркинга**:
   - `levelsDepth` (Глубина) — обязательно

3. **Для наземного паркинга**:
   - `floorsCount` (Количество этажей) — обязательно

**Правила для легкого паркинга**:

1. **Обязательные поля**:
   - `lightStructureType` — из `dict_light_structure_types`

**Правила для инфраструктуры**:

1. **Обязательные поля конструктива**:
   - `foundation`, `walls`, `slabs`, `roof`, `seismicity`

2. **Обязательные поля геометрии**:
   - `floorsCount` (Количество этажей)
   - `inputs` (Количество входов)

**Таблицы БД**:
- `buildings` (parking_type, construction_type, infra_type)
- `building_blocks` (floors_count, vehicle_entries, inputs, levels_depth, light_structure_type)
- `block_construction.*`

**Примеры ошибок**:
```javascript
{
  title: "Объект: Паркинг А (Блок: Основной блок)",
  description: "Не указана глубина подземного паркинга."
}

{
  title: "Объект: Паркинг Б (Блок: Основной блок)",
  description: "Не указано количество этажей паркинга."
}

{
  title: "Объект: Школа №5 (Блок: Основной блок)",
  description: "Поле \"Количество входов\" обязательно для заполнения."
}
```

### 7.3.4 Шаг `floors` — Внешняя инвентаризация

**Функция**: `STEP_VALIDATORS.floors(data)` → `validateFloors(data)`

**Проверяемые поля**:
- `floors.*` (массив этажей блока)

**Правила**:

1. **Наличие данных**:
   - Для каждого блока должны быть созданы этажи
   - Проверка: `blockFloorKeys.length > 0`

2. **Высота этажа**:
   - Обязательно для всех типов, кроме `roof`
   - Проверка: `!f.height` → ошибка "Не указана высота"
   - Валидатор: `Validators.floorHeight()`

3. **Проектная площадь**:
   - Обязательно для всех этажей
   - Проверка: `Validators.checkPositive(f.areaProj)`
   - Ошибка: "Не указана проектная площадь (S Проект)"

4. **Расхождение площадей (Правило 15%)**:
   - Проверка: `Validators.checkDiff(f.areaProj, f.areaFact)`
   - Ошибка: "Критическое расхождение S Проект/Факт (>15%). Уточните замеры."

**Исключения**:
- Стилобатные этажи жилых блоков скрыты на этом шаге и заполняются в связанном нежилом блоке
- Проверка: `isHiddenStylobateFloorForResidentialBlock()`

**Таблицы БД**:
- `floors` (height, area_proj, area_fact, floor_type, is_stylobate)

**Примеры ошибок**:
```javascript
{
  title: "Корпус 1 (Основной блок)",
  description: "Нет данных об этажах. Заполните матрицу высот и площадей."
}

{
  title: "Корпус 1 (Секция А)",
  description: "3 этаж: Не указана высота."
}

{
  title: "Корпус 1 (Секция А)",
  description: "5 этаж: Недопустимая высота (1.5). Высота должна быть 2.0-6.0 м"
}

{
  title: "Корпус 1 (Секция А)",
  description: "7 этаж: Критическое расхождение S Проект/Факт (>15%). Уточните замеры."
}
```

### 7.3.5 Шаг `entrances` — Инвентаризация подъездов

**Функция**: `STEP_VALIDATORS.entrances(data)` → `validateEntrances(data)`

**Проверяемые поля**:
- `entrance_matrix.*` (матрица этаж × подъезд)

**Правила**:

1. **Для смешанных/коммерческих этажей**:
   - Должно быть указано хотя бы одно помещение (квартиры или нежилые)
   - Проверка: `totalUnits > 0 OR totalApts > 0`
   - Ошибка: "Отмечен как нежилой/смешанный, но не указаны помещения"

2. **Для обычных жилых этажей**:
   - В каждом подъезде должно быть указано количество квартир
   - Проверка: `aptCount > 0` для каждой ячейки матрицы
   - Исключения:
     - Продолжение дуплекса (если предыдущий этаж дуплексный)
     - Если есть МОП без квартир
   - Ошибка: "Не указано количество квартир"

**Определение типа этажа**:
- Проверяется `floor.type` и `commercialFloors` из конфигурации блока
- Смешанный этаж: `floor.type === 'mixed'` или этаж есть в `commercialFloors`

**Игнорируемые типы этажей**:
- `technical`, `parking_floor`, `office`, `basement`, `tsokol`, `roof`, `loft`

**Таблицы БД**:
- `entrance_matrix` (flats_count, commercial_count, mop_count)
- `floors` (floor_type, is_duplex, is_technical, is_commercial)

**Примеры ошибок**:
```javascript
{
  title: "Корпус 1 (Секция А)",
  description: "1 этаж: Отмечен как нежилой/смешанный, но не указаны помещения."
}

{
  title: "Корпус 1 (Секция А)",
  description: "5 этаж (Подъезд 2): Не указано количество квартир."
}
```

### 7.3.6 Шаг `apartments` — Нумерация квартир

**Функция**: `STEP_VALIDATORS.apartments(data)` → `validateApartments(data)`

**Проверяемые поля**:
- `units.*` (массив помещений)
- `entrance_matrix.*` (плановые значения)

**Правила**:

1. **Дубликаты номеров**:
   - В пределах одного блока не должно быть помещений с одинаковыми номерами
   - Ключ проверки: `${buildingId}_${blockId}_${num}`
   - Ошибка: "В блоке обнаружен повторяющийся номер"

2. **Проверка дуплексов**:
   - Если этаж отмечен как `isDuplex=true` и на нем есть квартиры
   - Должна быть хотя бы одна двухуровневая квартира (`duplex_up` или `duplex_down`)
   - Ошибка: "Отмечен как 'Дуплексный', но не выбрано ни одной двухуровневой квартиры"

3. **Полнота нумерации**:
   - Количество пронумерованных квартир должно соответствовать плановому
   - Проверка: `numberedFloorTotal >= plannedFloorTotal`
   - Источник планового значения: `entrance_matrix.flats_count` (сумма по этажу)
   - Ошибка: "Пронумеровано N из M квартир"

**Таблицы БД**:
- `units` (number, unit_type, floor_id, block_id)
- `entrance_matrix` (flats_count)
- `floors` (is_duplex)

**Примеры ошибок**:
```javascript
{
  title: "Дубликаты номеров",
  description: "В блоке (ID: ...a1b2) обнаружен повторяющийся номер: \"42\"."
}

{
  title: "Ошибка дуплекса",
  description: "Блок \"Секция А\", этаж 5 этаж: отмечен как \"Дуплексный\", но не выбрано ни одной двухуровневой квартиры."
}

{
  title: "Незаполненные номера",
  description: "Блок \"Секция А\", этаж 3 этаж: пронумеровано 8 из 10 квартир."
}
```

### 7.3.7 Шаг `mop` — Инвентаризация МОП

**Функция**: `STEP_VALIDATORS.mop(data)` → `validateMop(data)`

**Проверяемые поля**:
- `common_areas.*` (массив МОП)
- `entrance_matrix.mop_count` (плановые значения)

**Правила**:

1. **Соответствие количества**:
   - Количество созданных МОП должно соответствовать плановому
   - Проверка: `mops.length >= targetQty`
   - Источник планового значения: `entrance_matrix.mop_count`
   - Ошибка: "Заявлено N МОП, а заполнено M"

2. **Полнота данных МОП**:
   - Для каждого МОП должны быть заполнены `type` и `area`
   - Проверка: `!m.type OR !m.area OR parseFloat(m.area) <= 0`
   - Ошибка: "У помещения №N не заполнен тип или площадь"

**Таблицы БД**:
- `common_areas` (type, area, floor_id, entrance_id)
- `entrance_matrix` (mop_count)

**Примеры ошибок**:
```javascript
{
  title: "Корпус 1 (Секция А)",
  description: "3 этаж (Подъезд 1): Заявлено 3 МОП, а заполнено 2."
}

{
  title: "Корпус 1 (Секция А)",
  description: "5 этаж (Подъезд 2): У помещения №1 не заполнен тип или площадь."
}
```

### 7.3.8 Шаг `parking_config` — Конфигурация паркинга

**Функция**: `STEP_VALIDATORS.parking_config(data)` → `validateParkingConfig(data)`

**Проверяемые поля**:
- `basements.*` и `basement_parking_levels.*` (для подземного паркинга в жилых домах)
- `units` (машиноместа в отдельных паркингах)
- `buildingDetails` (параметры паркинга)

**Правила для отдельного паркинга**:

1. **Глубина подземного паркинга**:
   - Для подземного паркинга обязательно `levelsDepth`
   - Проверка: `isUnderground AND !details.levelsDepth`
   - Ошибка: "Не указана глубина подземного паркинга"

2. **Этажность наземного капитального паркинга**:
   - Для наземного капитального паркинга обязательно `floorsCount`
   - Проверка: `!isUnderground AND isCapital AND !details.floorsCount`
   - Ошибка: "Не указана этажность паркинга"

3. **Наличие машиномест**:
   - Для капитального или подземного паркинга должно быть создано хотя бы одно машиноместо
   - Проверка: `!hasPlaces`
   - Ошибка: "Не создано ни одного машиноместа"

**Правила для подземного паркинга в жилом доме**:

1. **Количество мест на активных уровнях**:
   - Для каждого активного уровня (`is_enabled=true`) должно быть указано количество мест
   - Проверка: `!countVal OR count <= 0`
   - Ошибка: "Паркинг отмечен активным, но количество мест не указано"

**Таблицы БД**:
- `buildings` (parking_type, construction_type)
- `building_blocks` (levels_depth, floors_count)
- `basements` (has_parking, depth)
- `basement_parking_levels` (depth_level, is_enabled)
- `units` (unit_type='parking_place')

**Примеры ошибок**:
```javascript
{
  title: "Паркинг А",
  description: "Не указана глубина подземного паркинга."
}

{
  title: "Паркинг Б",
  description: "Не указана этажность паркинга."
}

{
  title: "Паркинг В",
  description: "Не создано ни одного машиноместа."
}

{
  title: "Корпус 1 (Секция А)",
  description: "Подвал (Уровень -2): Паркинг отмечен активным, но количество мест не указано."
}
```

## 7.4 Триггеры валидации

### 7.4.1 Валидация при сохранении

**Триггер**: Изменение полей в формах

**Действие**: Локальная валидация на стороне клиента (не блокирует сохранение)

**Цель**: Предупредить пользователя о потенциальных проблемах

### 7.4.2 Валидация при завершении шага

**Триггер**: Нажатие кнопки "Завершить шаг"

**Действие**: Вызов `validateStepCompletion(stepId, contextData)`

**Цель**: Блокировать переход на следующий шаг при наличии ошибок

**Логика**:
```javascript
const errors = validateStepCompletion(stepId, contextData);
if (errors && errors.length > 0) {
  // Показать ошибки
  // Заблокировать COMPLETE_STEP
  return;
}
// Разрешить COMPLETE_STEP
```

### 7.4.2a Валидация при кнопке «Сохранить» в редакторе здания (новое)

**Триггер**: Нажатие кнопки `Сохранить` в шапке редактора здания на шагах:
- `registry_nonres`
- `registry_res`
- `floors`
- `entrances`
- `apartments`
- `mop`

**Действие**:
1. Для выбранного здания вычисляются целевые блоки шага.
2. Для каждого блока запускается `validateStepCompletion(stepId, scopedContext)` — с контекстом, ограниченным этим блоком.
3. По наличию ошибок и фактических данных вычисляется статус блока:
   - `Заполнено` — ошибок нет;
   - `Не заполнено` — есть ошибки и данные по блоку отсутствуют;
   - `Заполнено частично` — есть ошибки и данные по блоку частично заполнены.
4. Статусы агрегируются на уровень здания и сохраняются в `application_steps.block_statuses` для текущего `step_index`.

**Цель**: дать пользователю промежуточный контроль качества заполнения по каждому зданию/блоку без завершения шага.

### 7.4.3 Валидация при проверке контролером

**Триггер**: Контролер открывает этап для проверки

**Действие**: Автоматический запуск валидации всех шагов этапа

**Цель**: Помочь контролеру выявить проблемы

**Примечание**: Контролер может Approve даже при наличии предупреждений (но не критических ошибок)

## 7.5 Типы сообщений валидации

### Критическая ошибка

**Уровень**: ERROR

**Цвет**: Красный

**Блокирует**: Завершение шага

**Пример**:
```javascript
{
  title: "Критическая ошибка состава",
  description: "В проекте отсутствует жилой дом."
}
```

### Предупреждение

**Уровень**: WARNING

**Цвет**: Желтый

**Блокирует**: Нет (но отображается)

**Пример**:
```javascript
{
  title: "Рекомендация",
  description: "Рекомендуется заполнить фактическую площадь для более точного учета."
}
```

### Информация

**Уровень**: INFO

**Цвет**: Синий

**Блокирует**: Нет

**Пример**:
```javascript
{
  title: "Подсказка",
  description: "Для дуплексов создается 2 записи: верхний и нижний уровни."
}
```

## 7.6 Отображение ошибок в UI

### Формат вывода

Ошибки группируются по объектам (зданиям/блокам/этажам) и отображаются списком:

```
❌ Объект: Корпус 1 (Блок: Секция А)
   • Поле "Фундамент" обязательно для заполнения.
   • Здание выше 5 этажей (7 эт.) обязано иметь лифт.

❌ Корпус 1 (Секция А)
   • 3 этаж: Не указана высота.
   • 5 этаж: Критическое расхождение S Проект/Факт (>15%).
```

### Компонент валидации

**Компонент**: Validation overlay/modal

**Расположение**: Появляется при попытке завершить шаг с ошибками

**Функциональность**:
- Список всех ошибок
- Группировка по объектам
- Ссылки на проблемные поля (если возможно)
- Кнопка "Исправить" (закрывает модал, фокусирует на первой ошибке)

## 7.7 Обход валидации

### Роль Admin

**Права**: Администратор может принудительно пропустить валидацию

**Использование**: Только в исключительных случаях (технические работы, миграция данных)

**Предупреждение**: При обходе валидации создается запись в `application_history` с комментарием

### Технический режим

**Флаг**: `BYPASS_VALIDATION` (доступен только в DEV)

**Использование**: Тестирование workflow без заполнения всех данных

**Предупреждение**: Не использовать в production
