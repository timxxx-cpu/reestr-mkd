# Реестр МКД — Документация проекта

Полная документация системы учета многоквартирных домов с описанием всех таблиц, связей, workflow, валидаций и процессов.

> **Стандарт**: При упоминании полей используется формат `поле_бд` -> `UI-поле` -> **русское название/разъяснение**.

## Оглавление

1. [Обзор проекта и архитектура](./01-overview-and-architecture.md)
   - Назначение системы
   - Базовые сущности
   - Архитектурные слои
   - Процессы загрузки и сохранения

2. [Полная структура БД (таблицы, поля, ключи, индексы)](./02-database-structure.md) ✨ **РАСШИРЕНО**
   - **CORE**: Проекты, заявки, история, шаги, участники, документы
   - **BUILDINGS + BLOCKS**: Здания, блоки, конструктив, инженерия, подвалы
   - **FLOORS / ENTRANCES / UNITS / MOP**: Этажи, подъезды, помещения, экспликация, МОП
   - **Справочники**: Полное описание всех `dict_*` таблиц с seed-данными
   - Для каждой таблицы: все поля, типы данных, ограничения, индексы, когда заполняется, откуда берутся значения

3. [ER-связи и целостность данных](./03-er-and-integrity.md) ✨ **РАСШИРЕНО**
   - Полная схема связей с диаграммами иерархии
   - Детальное описание всех Foreign Key с типами связей
   - Логика удаления (CASCADE vs SET NULL)
   - Уникальные индексы и составные ключи
   - CHECK-ограничения
   - Индексы для производительности

4. [Справочники, seed и DEV-доступ (RLS)](./04-dictionaries-seed-and-rls.md)
   - Полное описание всех справочников
   - Seed-данные для DEV-контура
   - RLS-политики для Supabase

5. [Workflow: роли, статусы, этапы, переходы](./05-workflow.md) ✨ **РАСШИРЕНО**
   - Детальное описание ролей (admin, branch_manager, technician, controller)
   - Жизненный цикл заявки (IN_PROGRESS + workflow_substatus → COMPLETED/DECLINED)
   - Конфигурация этапов и шагов
   - Полное описание workflow-операций:
     - COMPLETE_STEP (алгоритм, изменения в БД, примеры)
     - ROLLBACK_STEP (алгоритм, изменения в БД, примеры)
     - REVIEW_APPROVE (алгоритм, изменения в БД, примеры)
     - REVIEW_REJECT (алгоритм, изменения в БД, примеры)
     - Повторная подача по ЖК (проверка активного IN_PROGRESS и отказ при конфликте)
     - Передача заявки между техниками + блокировка конкурентного редактирования

6. [Пошаговый рабочий процесс](./06-operational-flow.md)
   - Пошаговое описание работы с каждым шагом
   - Какие данные вводятся на каждом шаге
   - Связь между шагами

7. [Логические и глобальные проверки](./07-validations.md) ✨ **РАСШИРЕНО**
   - Обзор системы валидации
   - Базовые валидаторы с формулами и примерами
   - Шаговые валидаторы для каждого шага:
     - composition, registry_res, registry_nonres
     - floors, entrances, apartments
     - mop, parking_config
   - Шаговый расчет и сохранение `Статуса заполнения блоков` (по кнопке `Сохранить` в редакторе здания)
   - Триггеры валидации
   - Типы сообщений (error, warning, info)
   - Отображение ошибок в UI

8. [Маппинг UI ↔ DB, синхронизация и миграционные заметки](./08-integration-sync-and-migration.md)
   - Соответствие UI-структур и таблиц БД
   - Логика синхронизации данных
   - Шаговый JSONB `application_steps.block_statuses` (статусы блоков по шагам)
   - Интеграция с УЗКАД
   - Миграционные заметки

9. [Роли, шаги и жизненный цикл данных (подробно)](./09-role-step-data-lifecycle.md) ✨ **РАСШИРЕНО**
   - Детальная таблица прав доступа по ролям
   - Пошаговое описание с таблицами мутаций:
     - Какие таблицы затрагиваются
     - Какие поля заполняются
     - Когда происходит заполнение
     - Откуда берутся значения (ввод пользователя, справочники, автогенерация)
   - SQL-операции для каждого действия
   - Логика работы на каждом шаге
   - Workflow-изменения при завершении шага

10. [Система идентификаторов УЖ (UJ Identifier System)](./10-uj-identifier-system.md) ✨ **НОВЫЙ**

11. [Версионирование объектов и логика работы](./11-object-versioning.md) ✨ **НОВЫЙ**
    - Таблица `object_versions` и справочник `dict_version_statuses`
    - Операции API: создание/утверждение/отклонение/восстановление версий
    - UI-компоненты: `VersionBadge`, `VersionHistory`


## Ключевые особенности документации

✅ **Полнота**: Описаны все таблицы, поля, связи, индексы  
✅ **Практичность**: SQL-примеры, алгоритмы, формулы валидации  
✅ **Русский язык**: Все термины переведены и объяснены  
✅ **Роли и права**: Детальное описание кто, что и когда может делать  
✅ **Workflow**: Полное описание машины состояний с примерами  
✅ **Валидации**: Все правила с примерами ошибок  
✅ **Трассируемость**: От UI-поля до БД и обратно  
✅ **Справочники**: Полное описание всех справочных таблиц  

## Источники кода

- **SQL-схема**: `db/reset_schema.sql`
- **Workflow**: `src/lib/workflow-state-machine.js`, `src/lib/constants.js`
- **Валидации**: `src/lib/step-validators.js`, `src/lib/validators.js`
- **Идентификаторы**: `src/lib/uj-identifier.js`
- **Маппинг**: `src/lib/db-mappers.js`, `src/lib/dto.js`
- **API**: `src/lib/api-service.js`, `src/lib/api/*`
- **Контекст**: `src/context/project/*`
- **Компоненты**: `src/components/editors/*`

## Как использовать документацию

1. **Для разработчиков**: Начните с [01-overview-and-architecture.md](./01-overview-and-architecture.md), затем [02-database-structure.md](./02-database-structure.md)
2. **Для аналитиков**: [05-workflow.md](./05-workflow.md) и [09-role-step-data-lifecycle.md](./09-role-step-data-lifecycle.md)
3. **Для тестировщиков**: [07-validations.md](./07-validations.md) и [06-operational-flow.md](./06-operational-flow.md)
4. **Для БД-специалистов**: [02-database-structure.md](./02-database-structure.md) и [03-er-and-integrity.md](./03-er-and-integrity.md)
5. **Для интеграторов**: [10-uj-identifier-system.md](./10-uj-identifier-system.md), [08-integration-sync-and-migration.md](./08-integration-sync-and-migration.md), [11-object-versioning.md](./11-object-versioning.md)

## Статус документации

✅ **Завершено**: Все основные разделы документированы  
✅ **Актуально**: Соответствует текущей версии кода и схеме (включая workflow_substatus; versioning временно отключен feature-flag в DEV без изменений БД)  
✅ **Проверено**: Документация сверена с исходным кодом, workflow-логикой и актуальной схемой БД (включая lock-RPC и статусы версий CURRENT/PENDING/REJECTED/PREVIOUS)  

## Обратная связь

При обнаружении неточностей или необходимости дополнений, пожалуйста, создайте issue или pull request.
