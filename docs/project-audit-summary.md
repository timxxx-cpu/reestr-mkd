# Аудит проекта `reestr-mkd` (архитектура, логика, workflow)

Краткая техническая шпаргалка по текущему состоянию тестового проекта (DEV на Supabase/PostgreSQL).

## 1. Текущая цель проекта

- SPA для ведения жизненного цикла заявки и инвентаризации МКД.
- Основной сценарий: создать/принять заявку, заполнить шаги паспорта и состава комплекса, построить этажно-подъездные матрицы, сформировать реестры, дойти до интеграции.
- Контур DEV допускает полный reset схемы БД без сохранения данных.

## 2. Архитектурная схема (слои)

1. **UI-слой** (`src/components`, `src/App.jsx`): редакторы по шагам + маршрутизация + role-based ограничения.
2. **State-слой** (`ProjectContext` + project hooks):
   - загрузка (`useProjectData`),
   - merge server/local (`useProjectDataLayer`),
   - сохранение (`useProjectSyncLayer`),
   - workflow-переходы (`useProjectWorkflowLayer`).
3. **Data-access** (`ApiService`): чтение/запись в Supabase, batch-save, upsert с `onConflict`.
4. **DB schema** (`db/reset_schema.sql`): нормализованные сущности проекта/заявки/зданий/этажей/помещений/реестров + `dict_*`.

## 3. Бизнес-логика workflow

- Базовые статусы: `NEW`, `DRAFT`, `REVIEW`, `REJECTED`, `INTEGRATION`, `COMPLETED`.
- Исполнитель (technician) работает по текущему активному шагу, контролер подтверждает этапы.
- На границах этапов выполняется переход в `REVIEW`; при подтверждении — движение дальше, при отклонении — возврат на доработку.
- История действий хранится в `application_history`, детализация прогресса шагов — в `application_steps`.

## 4. Что важно про сохранение данных

- Проект опирается на idempotent upsert-ы (карта `UPSERT_ON_CONFLICT` в `ApiService`).
- Для тяжелых разделов используется отложенное накопление (`pendingUpdatesRef`) и затем синхронный flush через `saveProjectImmediate`.
- После записи выполняется `refetch` для выравнивания локального состояния относительно БД.

## 5. Схема БД (ключевые связи)

- `projects` ↔ `applications` (1:1 через `project_id unique`).
- `applications` ↔ `application_history` / `application_steps`.
- `buildings` → `building_blocks` → `floors` → `units` / `rooms` / `common_areas`.
- `entrance_matrix` фиксирует связку блок-этаж-подъезд (`UNIQUE(block_id, floor_id, entrance_number)`).
- Скрипт reset включает DEV-RLS и permissive policy для `anon/authenticated`.

## 6. Практический workflow разработки на текущем этапе миграции

1. Reset схемы через `db/reset_schema.sql` в Supabase SQL Editor.
2. Smoke проход по критичным шагам UI (паспорт → состав → этажи/подъезды → реестры → интеграция).
3. Проверка переходов `REVIEW/REJECT/INTEGRATION`.
4. При изменении модели данных — синхронизировать `ApiService`, мапперы и документацию.

## 7. Риски текущего состояния (как тестового контура)

- Логика сильно завязана на прямой доступ фронтенда к Supabase-таблицам.
- Расхождение между UI-моделью и DB-моделью критично при любых изменениях схемы/мапперов.
- Из-за активного рефактора миграции PostgreSQL важно фиксировать контракты upsert и уникальные ключи в одном месте.

## 8. Готовность к дальнейшей диагностике

Проект изучен в части:
- архитектуры frontend/data/workflow,
- таблиц и ограничений БД,
- процедур reset и smoke-проверок,
- точек потенциальных сбоев при миграции.

Можно переходить к разбору конкретных проблем/дефектов по шагам или по таблицам.
