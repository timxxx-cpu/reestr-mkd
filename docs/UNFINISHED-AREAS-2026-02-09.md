# Что в проекте пока не доведено до конца (аудит)

**Дата:** 9 февраля 2026  
**Контекст:** тестовый стенд, миграция на PostgreSQL, DEV через Supabase.

## 1) Короткий вывод

Проект функционально рабочий для DEV-цикла (ввод данных, workflow, реестры), но в коде и процессах остаются незавершенные контуры, которые критичны для production:

1. Авторизация и роли пока в demo-режиме (mock user в localStorage).
2. Контур внешней интеграции (УЗКАД) работает как UI-эмуляция, без реального транспорта/обработки ответов.
3. Безопасность БД на уровне SQL-схемы не завершена (в reset-схеме нет production RLS-политик).
4. Тестовое покрытие ограничено smoke/contract тестами, нет полноценного покрытия UI и data-layer.
5. Часть UI-логики опирается на fallback/заглушки для отсутствующих сущностей.

---

## 2) Что изучено

- Архитектура и workflow: `README.md`, `docs/project-full-architecture.md`, `docs/project-full-workflow.md`.
- Схема БД: `db/reset_schema.sql`.
- Критические контуры UI/логики: `src/App.jsx`, `src/lib/auth-service.js`, `src/components/ApplicationsDashboard.jsx`, `src/components/editors/IntegrationBuildings.jsx`, `src/components/editors/IntegrationUnits.jsx`, `src/lib/utils.js`.
- Текущие рекомендации и исторический анализ: `docs/README.md`, `docs/IMPROVEMENT-PROPOSALS-2026-02-09.md`, `docs/QUICK-WINS-2026-02-09.md`.

---

## 3) Незавершенные блоки (по приоритету)

## P0 — блокеры production

### 3.1 Demo-auth вместо боевого auth

**Симптом:** `AuthService` хранит пользователя в `localStorage` (`mock_user`) и использует `signInDemo`.

**Риск:**
- нет реальной аутентификации;
- роли нельзя считать защищенными;
- нельзя безопасно расширять на боевой контур.

**Что довести:**
- подключить реальный auth provider;
- связать роль пользователя с доверенным backend-источником;
- убрать зависимость от `mock_user`.

### 3.2 Интеграция УЗКАД как эмуляция

**Симптом:** в интеграционных экранах есть сценарии `setTimeout`/"Получить ответ (Эмуляция)".

**Риск:**
- нет гарантированного реального обмена;
- нет корреляции запрос/ответ;
- невозможен аудит ошибок интеграции на бою.

**Что довести:**
- вынести интеграцию в явный API-контур (request id, статусы, retry);
- добавить обработку ошибок/таймаутов и хранение журналов обмена;
- заменить демо-кнопки на реальные операции.

### 3.3 Security-hardening БД

**Симптом:** reset-схема ориентирована на DEV-reset и не содержит явного production блока RLS/политик.

**Риск:**
- нельзя безопасно выпускать multi-user сценарии;
- изоляция по `scope_id` держится в прикладной логике, а не в полной мере на уровне БД.

**Что довести:**
- добавить/версионировать production-политики RLS;
- закрепить ограничения по `scope_id` и роли на уровне SQL;
- формализовать безопасный migration path DEV→PROD.

---

## P1 — важные функциональные доработки

### 3.4 Неполный тестовый контур

**Симптом:** в npm scripts нет полного набора тестов по UI/data/workflow e2e, фокус на smoke/contract.

**Риск:**
- высокий риск регрессий в сложных шагах workflow;
- ручная проверка остается основным способом валидации.

**Что довести:**
- добавить unit-тесты для критичных хуков/data-mappers;
- добавить интеграционные тесты для workflow-переходов;
- добавить e2e smoke для ключевых пользовательских сценариев.

### 3.5 Fallback-заглушки в доменной модели

**Симптом:** часть UI-сущностей создается как fallback (например блок `main` при отсутствии блоков).

**Риск:**
- в edge-cases возможна путаница между «реальными» и «виртуальными» сущностями;
- возможны ошибки при последующем сохранении и маппинге.

**Что довести:**
- унифицировать стратегию виртуальных сущностей;
- явно помечать виртуальные ID/типы в модели;
- покрыть такие ветки тестами.

---

## P2 — операционная зрелость

### 3.6 Наблюдаемость и эксплуатация

**Симптом:** текущий контур ориентирован на dev-flow; централизованное логирование/метрики/алерты описаны как планы.

**Что довести:**
- логирование интеграционных и workflow-событий;
- базовые метрики ошибок/latency;
- runbook инцидентов для интеграции.

### 3.7 CI/CD и quality gates

**Симптом:** не зафиксирован жесткий pipeline с обязательными quality gates.

**Что довести:**
- pipeline: lint + test + build;
- обязательный check перед merge;
- минимальный порог покрытия по критичным модулям.

---

## 4) Предлагаемый порядок закрытия

1. **Auth + RLS (P0)** — закрыть безопасность и модель доступа.
2. **Реальная интеграция УЗКАД (P0)** — заменить эмуляции на рабочий канал.
3. **Тесты (P1)** — зафиксировать защиту от регрессий.
4. **Fallback-ветки (P1)** — нормализовать виртуальные сущности.
5. **Observability + CI/CD (P2)** — довести эксплуатационную зрелость.

---

## 5) Практический статус

Для тестового стенда текущее состояние **достаточно рабочее**. Для production — **нужен отдельный hardening-спринт** по пунктам выше.
