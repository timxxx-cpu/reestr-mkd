# DB reset runbook (DEV / Supabase)

Этот документ описывает **полный перезапуск DEV-схемы** и проверку актуального workflow после reset.

> Контекст: проект тестовый, DEV-данные можно пересоздавать с нуля.

---

## 1) Что делает reset

Скрипт `db/reset_schema.sql`:

- полностью пересоздает core-таблицы проекта и workflow;
- пересоздает инвентаризационные таблицы (этажи, подъезды, матрица, юниты, МОП, подвалы/паркинг);
- пересоздает `dict_*` каталоги и seed;
- выставляет DEV-RLS и доступы для `anon/authenticated`.

SQL: `db/reset_schema.sql`.

---

## 2) Предусловия

Перед запуском убедиться, что:

1. Вы в **DEV Supabase project** (не Stage/Prod).
2. Понимаете, что скрипт **удаляет все текущие данные**.
3. Фронт настроен на DEV env (`VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`).

---

## 3) Порядок запуска reset

1. Открыть Supabase SQL Editor.
2. Вставить и выполнить `db/reset_schema.sql` целиком (одним скриптом).
3. Дождаться `commit;` без ошибок.
4. Перезапустить фронт:

```bash
npm run dev
```

---

## 4) Актуальная сетка шагов (индексы `STEPS_CONFIG`)

После reset smoke-проверка должна идти по **текущей** сетке шагов:

| Индекс | ID шага | Назначение |
|---:|---|---|
| 0 | `passport` | Паспорт ЖК |
| 1 | `composition` | Состав комплекса |
| 2 | `registry_nonres` | Нежилые блоки/инфраструктура |
| 3 | `registry_res` | Жилые блоки |
| 4 | `floors` | Инвентаризация этажей |
| 5 | `entrances` | Матрица подъездов |
| 6 | `apartments` | Нумерация квартир |
| 7 | `mop` | МОП |
| 8 | `parking_config` | Конфигурация паркинга |
| 9 | `registry_apartments` | Реестр квартир |
| 10 | `registry_commercial` | Реестр нежилых |
| 11 | `registry_parking` | Реестр машиномест |
| 12 | `integration_buildings` | Интеграция: здания |
| 13 | `integration_units` | Интеграция: помещения |
| 14 | `registry_nonres_view` | Сводная нежилых |
| 15 | `registry_res_view` | Сводная жилых |
| 16 | `summary` | Итоговая сводная |

---

## 5) Smoke-check после reset (подробно)

### A. Базовый сценарий

1. Создать проект из dashboard.
2. На шаге 0 (`passport`) заполнить минимум полей и сохранить.
3. На шаге 1 (`composition`) создать минимум 1 жилой объект/блок.
4. Пройти шаги 2–8, создавая минимально валидные данные:
   - этажи,
   - матрица подъездов,
   - нумерация,
   - МОП,
   - паркинг.
5. Пройти шаги 9–11 (реестры).
6. Проверить шаги 12–13 (интеграционные экраны открываются, данные читаются).
7. Проверить шаги 14–16 (сводные строятся без падений).

### B. Проверка контрольных точек этапов workflow

- После завершения шага **5** — переход в `REVIEW` (граница этапа 1).
- После завершения шага **8** — переход в `REVIEW` (граница этапа 2).
- После завершения шага **11** — переход в `REVIEW` (граница этапа 3).
- Финальный шаг **16** — перевод в `COMPLETED`.

### C. Проверка ролей

- `technician`: может редактировать в `DRAFT/NEW/REJECTED/INTEGRATION`.
- `controller`: read-only (проверка/ревью).
- `admin`: полный доступ.

---

## 6) Критичные гарантии схемы

Проверяем, что сохранены ключевые инварианты:

- `applications` связана с `projects` (`project_id` unique) и хранит `status`, `current_step`, `current_stage`, `integration_data`.
- `application_steps` — уникальность `(application_id, step_index)`.
- `application_history` — журнал действий.
- `entrance_matrix` — уникальность `(block_id, floor_id, entrance_number)`.
- `basement_parking_levels` — уникальность `(basement_id, depth_level)`.

---
